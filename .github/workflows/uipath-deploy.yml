name: UiPath Build and Deploy

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'environment to deploy'
        required: true
        default: ''
        type: choice
        options:
          - Shared
          - Development Environment

      bot:
        description: 'Enter bot name (leave empty to deploy all changed bots)'
        required: false
        default: ''

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      UIPATH_CLIENT_ID: ${{ secrets.UIPATH_CLIENT_ID }}
      UIPATH_CLIENT_SECRET: ${{ secrets.UIPATH_CLIENT_SECRET }}
      UIPATH_ORG: ${{ secrets.UIPATH_ORG }}
      UIPATH_TENANT: ${{ secrets.UIPATH_TENANT }}
      UIPATH_URL: ${{ secrets.UIPATH_URL }}

    steps:
      # ---------------------------------------------------------
      # ðŸ”’ VALIDATION STEP
      # ---------------------------------------------------------
      - name: Validate environment input
        shell: powershell
        run: |
          if ("${{ github.event.inputs.environment }}" -eq "") {
            Write-Error "Environment must be selected"
            exit 1
          }
          Write-Host "Running the bots in ENV : ${{ github.event.inputs.environment }}"

      # -----------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # -----------------------------------------------------------
      # Setup UiPath CLI (uipcli)
      # -----------------------------------------------------------
      # - name: Setup UiPath CLI
      #   uses: Mikael-RnD/setup-uipath@v2

      - name: Verify UiPath CLI
        shell: powershell
        run: UiPath --version

      # -----------------------------------------------------------
      # Read bots list
      # -----------------------------------------------------------
      - name: Read bots list
        id: readbots
        shell: powershell
        run: |
          if (-not (Test-Path "bots.txt")) {
            Write-Error "bots.txt not found!"
            exit 1
          }

          $BOTS = Get-Content bots.txt |
                  ForEach-Object { $_.Trim() } |
                  Where-Object { $_ -ne "" }

          Write-Host "Available bots: $($BOTS -join ', ')"

          $botsOutput = $BOTS -join ' '
          echo "bots=$botsOutput" >> $env:GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Determine bots to build
      # -----------------------------------------------------------
      - name: Determine bots to build
        id: buildbots
        shell: powershell
        run: |
          $inputBot = "${{ github.event.inputs.bot }}".Trim()

          # ------------- Get bot name from .txt file ---------------------
          $allBots = "${{ steps.readbots.outputs.bots }}".Split(
            " ",
            [System.StringSplitOptions]::RemoveEmptyEntries
          )

          if ($inputBot) {
            if ($allBots -notcontains $inputBot) {
              Write-Error "Bot '$inputBot' not found in bots.txt"
              exit 1
            }

            $toBuild = @($inputBot)
            Write-Host "Deploying specified bot: $inputBot"
          }
          else {
            Write-Warning "Bot name not provided in input!!! Please enter the Bot name to deploy."
            exit 1
          }

          echo "to_build=$($toBuild -join ' ')" >> $env:GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Build UiPath packages
      # -----------------------------------------------------------
      - name: Build UiPath packages
        shell: powershell
        run: |
          $artifactsPath = "artifacts"

          if (-not (Test-Path $artifactsPath)) {
            New-Item -ItemType Directory -Path $artifactsPath | Out-Null
          }

          $botsToBuild = "${{ steps.buildbots.outputs.to_build }}".Split(
            " ",
            [System.StringSplitOptions]::RemoveEmptyEntries
          )

          Write-Warning "list of bots to build $botsToBuild"

          foreach ($bot in $botsToBuild) 
          {
            $projectJsonContent = git show HEAD:$bot/project.json
            if (-not $projectJsonContent)
             {
               Write-Warning "project.json not found in commit for $bot."
               exit 1
             }
            $projectData = $projectJsonContent | ConvertFrom-Json
            $repoVersion = $projectData.projectVersion.Split(".")

            $patch = [int]$repoVersion[2] + 1
            $newVersion = "$($repoVersion[0]).$($repoVersion[1]).$patch"

            $projectData.projectVersion = $newVersion
            $existingProjectJsonPath = Join-Path $bot "project.json"

            if (-not (Test-Path $existingProjectJsonPath)) {
              Write-Error "project.json does not exist in workspace for $bot"
              exit 1
            }
            $projectData | ConvertTo-Json -Depth 10 | Set-Content -Path $existingProjectJsonPath -Force

            Write-Host "Updated $existingProjectJsonPath"

            $botArtifactPath = Join-Path $artifactsPath $bot

            if (-not (Test-Path $botArtifactPath)) {
              New-Item -ItemType Directory -Path $botArtifactPath | Out-Null
            }

            $outputProjectJson = Join-Path $botArtifactPath "project.json"

            $projectData |
              ConvertTo-Json -Depth 10 |
              Set-Content $outputProjectJson

            uipcli package pack "$outputProjectJson" --traceLevel Information -o "$botArtifactPath" --libraryOrchestratorUrl "$env:UIPATH_URL" --libraryOrchestratorTenant "$env:UIPATH_TENANT" -A "$env:UIPATH_ORG" -I "$env:UIPATH_CLIENT_ID" -S "$env:UIPATH_CLIENT_SECRET" --libraryOrchestratorApplicationScope "OR.Folders"
          
          # -----------------------------
          # Committing changes
          # -----------------------------
          $ErrorActionPreference = "Stop"

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          Write-Host "commiting changes of - $existingProjectJsonPath"

          git status
          git add $existingProjectJsonPath
          git status

          if (-not (git diff --cached --quiet)) {
            git commit -m "Bump project version(s) in project.json"
            git push origin HEAD:${{ github.ref }}
            Write-Host "Committed and pushed updated project.json files"
          }
            else
          {
            Write-Host "No changes to commit "
          }
          }
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------
      # Deploy packages
      # -----------------------------------------------------------
      - name: Deploy packages
        shell: powershell
        run: |
          $environment = "${{ github.event.inputs.environment }}"

          Write-Host "ðŸš€ Deploying to Orchestrator folder: $environment and uipath url - $env:UIPATH_URL"

          $nupkgs = Get-ChildItem "artifacts" -Recurse -Filter *.nupkg

          Write-Host "Anjali artifact $nupkgs"

          if (-not $nupkgs) {
            Write-Host "âš  No artifacts found to deploy."
            exit 0
          }

          foreach ($pkg in $nupkgs) {
            Write-Host "ðŸ“¦ Deploying $($pkg.FullName) to folder $environment"

            $inputBot = "${{ github.event.inputs.bot }}".Trim()

            uipcli package deploy "$($pkg.FullName)" `
              "$env:UIPATH_URL" `
              "$env:UIPATH_TENANT" `
              -A "$env:UIPATH_ORG" `
              -I "$env:UIPATH_CLIENT_ID" `
              -S "$env:UIPATH_CLIENT_SECRET" `
              -o "$environment" `
              --applicationScope "OR.Folders OR.BackgroundTasks OR.TestSets OR.TestSetExecutions OR.TestSetSchedules OR.Settings.Read OR.Robots.Read OR.Machines.Read OR.Execution OR.Assets OR.Users.Read OR.Jobs OR.Monitoring" `
              --traceLevel Information `
              --entryPointsPath "Main.xaml" `
              --processName "$inputBot"
          }
