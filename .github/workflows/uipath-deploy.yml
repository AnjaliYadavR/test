name: UiPath Build and Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment to deploy'
        required: true
        default: 'Dev'
        type: choice
        options:
          - Dev
          - Test
          - Prod
      bot:
        description: 'Enter bot name (leave empty to deploy all changed bots)'
        required: false
        default: ''

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      UIPATH_CLIENT_ID: ${{ secrets.UIPATH_CLIENT_ID }}
      UIPATH_CLIENT_SECRET: ${{ secrets.UIPATH_CLIENT_SECRET }}
      UIPATH_ORG: ${{ secrets.UIPATH_ORG }}
      UIPATH_TENANT: ${{ secrets.UIPATH_TENANT }}
      UIPATH_URL: ${{ secrets.UIPATH_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important for 'git diff' to work correctly

      # -----------------------------------------------------------
      # Official UiPath Action - Fixes the Invoke-WebRequest error
      # -----------------------------------------------------------
      - name: Setup UiPath CLI
        uses: uipath/setup-uipath@v2
        with:
          uipath-cli-version: '23.10.8712.28549'

      - name: Verify UiPath CLI
        shell: pwsh
        run: uipath --version

      - name: Read bot list
        id: readbots
        shell: bash
        run: |
          echo "Reading bots.txt..."
          BOTS=$(cat bots.txt)
          echo "bots=$BOTS" >> $GITHUB_OUTPUT
          echo "Available bots:"
          echo "$BOTS"

      - name: Validate bot input (if provided)
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.bot }}" ]; then
            echo "Validating bot: ${{ github.event.inputs.bot }}"
            if ! grep -qw "${{ github.event.inputs.bot }}" bots.txt; then
              echo "ERROR: Bot '${{ github.event.inputs.bot }}' not found in bots.txt"
              exit 1
            fi
          else
            echo "No bot specified. Will deploy all changed bots."
          fi

      - name: Determine bots to build
        id: buildbots
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.bot }}" ]; then
            TO_BUILD="${{ github.event.inputs.bot }}"
          else
            # Get changed bots based on project.json files
            CHANGED_BOTS=$(git diff --name-only HEAD~1 HEAD | grep project.json | awk -F/ '{print $1}' | sort | uniq)
            TO_BUILD=""
            for bot in $CHANGED_BOTS; do
              if echo "${{ steps.readbots.outputs.bots }}" | grep -qw "$bot"; then
                TO_BUILD="$TO_BUILD $bot"
              fi
            done
          fi

          if [ -z "$TO_BUILD" ]; then
            echo "âš  No bots to build."
          else
            echo "Bots to build:$TO_BUILD"
          fi

          echo "to_build=$TO_BUILD" >> $GITHUB_OUTPUT

      - name: Build UiPath packages
        shell: bash
        run: |
          mkdir -p artifacts
          for bot in ${{ steps.buildbots.outputs.to_build }}; do
            echo "ðŸ”¨ Building $bot"
            uipath package restore --project-path "$bot"
            uipath package pack --project-path "$bot" --output "artifacts/$bot"
          done

      - name: Login to UiPath Orchestrator
        shell: bash
        run: |
          uipath auth login \
            --client-id "$UIPATH_CLIENT_ID" \
            --client-secret "$UIPATH_CLIENT_SECRET" \
            --account-name "$UIPATH_ORG" \
            --tenant "$UIPATH_TENANT" \
            --url "$UIPATH_URL"

      - name: Deploy packages
        shell: bash
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          echo "ðŸš€ Deploying to environment: $ENVIRONMENT"

          if [ -d "artifacts" ] && [ "$(ls -A artifacts)" ]; then
            for pkg in artifacts/*; do
              # The pack command creates folders per bot, find the .nupkg inside
              NUPKG=$(find "$pkg" -name "*.nupkg")
              if [ -n "$NUPKG" ]; then
                echo "Deploying $(basename "$NUPKG") to $ENVIRONMENT folder"
                uipath package deploy --package-path "$NUPKG" --folder "$ENVIRONMENT"
              fi
            done
          else
            echo "No artifacts found to deploy."
          fi