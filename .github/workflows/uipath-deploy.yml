name: UiPath Build and Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment to deploy'
        required: true
        default: 'Dev'
        type: choice
        options:
          - Dev
          - Test
          - Prod
      bot:
        description: 'Enter bot name (leave empty to deploy all changed bots)'
        required: false
        default: ''

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      UIPATH_CLIENT_ID: ${{ secrets.UIPATH_CLIENT_ID }}
      UIPATH_CLIENT_SECRET: ${{ secrets.UIPATH_CLIENT_SECRET }}
      UIPATH_ORG: ${{ secrets.UIPATH_ORG }}
      UIPATH_TENANT: ${{ secrets.UIPATH_TENANT }}
      UIPATH_URL: ${{ secrets.UIPATH_URL }}

    steps:
      # -----------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------
      # Setup UiPath CLI (uipcli)
      # -----------------------------------------------------------
      - name: Setup UiPath CLI
        uses: Mikael-RnD/setup-uipath@v2

      - name: Verify UiPath CLI
        shell: pwsh
        run: uipcli --version

      # -----------------------------------------------------------
      # Read bots list
      # -----------------------------------------------------------
      - name: Read bots list
        id: readbots
        shell: pwsh
        run: |
          if (-not (Test-Path "bots.txt")) {
              Write-Error "bots.txt not found!"
              exit 1
          }

          $BOTS = Get-Content bots.txt | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }
          Write-Host "Available bots: $($BOTS -join ', ')"

          # Export to GitHub output
          $botsOutput = $BOTS -join ' '
          echo "bots=$botsOutput" >> $env:GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Determine bots to build
      # -----------------------------------------------------------
      - name: Determine bots to build
        id: buildbots
        shell: pwsh
        run: |
          $inputBot = "${{ github.event.inputs.bot }}".Trim()
          $allBots = "${{ steps.readbots.outputs.bots }}".Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries)

          if ($inputBot) {
              if ($allBots -notcontains $inputBot) {
                  Write-Error "Bot '$inputBot' not found in bots.txt"
                  exit 1
              }
              $toBuild = @($inputBot)
              Write-Host "Deploying specified bot: $inputBot"
          } else {
              # Determine changed bots
              git fetch origin main
              $changedFiles = git diff --name-only origin/main...HEAD
              $changedBots = $changedFiles | ForEach-Object {
                  $_.Split("/")[0]
              } | Sort-Object -Unique

              $toBuild = @()
              foreach ($bot in $changedBots) {
                  if ($allBots -contains $bot) {
                      $toBuild += $bot
                  }
              }

              if ($toBuild.Count -eq 0) {
                  Write-Host "âš  No changed bots to build."
              } else {
                  Write-Host "Bots to build: $($toBuild -join ', ')"
              }
          }

          # Export to GitHub output
          echo "to_build=$($toBuild -join ' ')" >> $env:GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Build packages
      # -----------------------------------------------------------
      - name: Build UiPath packages
        shell: pwsh
        run: |
          $artifactsPath = "artifacts"
          if (-not (Test-Path $artifactsPath)) {
              New-Item -ItemType Directory -Path $artifactsPath | Out-Null
          }
      
          $botsToBuild = "${{ steps.buildbots.outputs.to_build }}".Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries)
      
          if ($botsToBuild.Count -eq 0) {
              Write-Host "âš  No bots to build. Skipping build step."
              exit 0
          }
      
          foreach ($bot in $botsToBuild) {
              Write-Host "ðŸ”¨ Building $bot"
              
              # Use new UiPath CLI syntax
              uipcli package pack `
                  "$bot" `                       # workspace path / folder containing project.json
                  -o "$artifactsPath\$bot" `     # output folder
                  --traceLevel Information `
                  -A "$env:UIPATH_ORG" `
                  -I "$env:UIPATH_CLIENT_ID" `
                  -S "$env:UIPATH_CLIENT_SECRET" `
                  --libraryOrchestratorApplicationScope "OR.Folders"
          }

      # -----------------------------------------------------------
      # Deploy packages
      # -----------------------------------------------------------
      - name: Deploy packages
        shell: pwsh
        run: |
          $ENVIRONMENT = "${{ github.event.inputs.environment }}"
          Write-Host "ðŸš€ Deploying to Orchestrator folder: $ENVIRONMENT"

          $artifactsPath = "artifacts"
          if (-not (Test-Path $artifactsPath)) {
              Write-Host "âš  No artifacts folder found. Nothing to deploy."
              exit 0
          }

          $nupkgs = Get-ChildItem -Path $artifactsPath -Recurse -Filter *.nupkg
          if (-not $nupkgs) {
              Write-Host "âš  No .nupkg files found. Nothing to deploy."
              exit 0
          }

          foreach ($pkg in $nupkgs) {
              Write-Host "ðŸ“¦ Deploying $($pkg.FullName) to folder $ENVIRONMENT"
              uipcli package deploy `
                  "$($pkg.FullName)" `
                  "$env:UIPATH_URL" `
                  "$env:UIPATH_TENANT" `
                  -A "$env:UIPATH_ORG" `
                  -I "$env:UIPATH_CLIENT_ID" `
                  -S "$env:UIPATH_CLIENT_SECRET" `
                  --applicationScope "OR.Folders" `
                  -o "$env:UIPATH_ORG"
          }
