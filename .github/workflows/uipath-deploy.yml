name: UiPath Build and Deploy

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'environment to deploy'
        required: true
        default: ''
        type: choice
        options:
          - Shared
          - Development Environment
      bot:
        description: 'Enter bot name (leave empty to deploy all changed bots)'
        required: false
        default: ''

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      UIPATH_CLIENT_ID: ${{ secrets.UIPATH_CLIENT_ID }}
      UIPATH_CLIENT_SECRET: ${{ secrets.UIPATH_CLIENT_SECRET }}
      UIPATH_ORG: ${{ secrets.UIPATH_ORG }}
      UIPATH_TENANT: ${{ secrets.UIPATH_TENANT }}
      UIPATH_URL: ${{ secrets.UIPATH_URL }}

    steps:
      #---------------------------------------------------------
      # ðŸ”’ VALIDATION STEP (THIS IS WHERE IT GOES)
      #---------------------------------------------------------
      - name: Validate environment input
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.environment }}" -eq "") {
            Write-Error "Environment must be selected"
            exit 1
          }
          Write-Host "Running the bots in ENV : ${{ github.event.inputs.environment }}"
      # -----------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # -----------------------------------------------------------
      # Setup UiPath CLI (uipcli)
      # -----------------------------------------------------------
      - name: Setup UiPath CLI
        uses: Mikael-RnD/setup-uipath@v2

      - name: Verify UiPath CLI
        shell: pwsh
        run: uipcli --version

      # -----------------------------------------------------------
      # Read bots list
      # -----------------------------------------------------------
      - name: Read bots list
        id: readbots
        shell: pwsh
        run: |
          if (-not (Test-Path "bots.txt")) {
              Write-Error "bots.txt not found!"
              exit 1
          }

          $BOTS = Get-Content bots.txt | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }
          Write-Host "Available bots: $($BOTS -join ', ')"

          # Export to GitHub output
          $botsOutput = $BOTS -join ' '
          echo "bots=$botsOutput" >> $env:GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Determine bots to build
      # -----------------------------------------------------------
      - name: Determine bots to build
        id: buildbots
        shell: pwsh
        run: |
          $inputBot = "${{ github.event.inputs.bot }}".Trim()
          $allBots = "${{ steps.readbots.outputs.bots }}".Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries)

          if ($inputBot) {
              if ($allBots -notcontains $inputBot) {
                  Write-Error "Bot '$inputBot' not found in bots.txt"
                  exit 1
              }
              $toBuild = @($inputBot)
              Write-Host "Deploying specified bot: $inputBot"
          } else {
              # Determine changed bots
              git fetch origin main
              $changedFiles = git diff --name-only origin/main...HEAD
              $changedBots = $changedFiles | ForEach-Object {
                  $_.Split("/")[0]
              } | Sort-Object -Unique

              $toBuild = @()
              foreach ($bot in $changedBots) {
                  if ($allBots -contains $bot) {
                      $toBuild += $bot
                  }
              }

              if ($toBuild.Count -eq 0) {
                  Write-Host "âš  No changed bots to build."
              } else {
                  Write-Host "Bots to build: $($toBuild -join ', ')"
              }
          }

          # Export to GitHub output
          echo "to_build=$($toBuild -join ' ')" >> $env:GITHUB_OUTPUT

     # -----------------------------------------------------------
      # Build UiPath packages (read project.json from commit, auto-version)
      # -----------------------------------------------------------
      - name: Build UiPath packages
        shell: pwsh
        run: |
          $artifactsPath = "artifacts"
          if (-not (Test-Path $artifactsPath)) { New-Item -ItemType Directory -Path $artifactsPath | Out-Null }

          $botsToBuild = "${{ steps.buildbots.outputs.to_build }}".Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries)

          foreach ($bot in $botsToBuild) {
              # Read project.json directly from commit
              $projectJsonContent = git show HEAD:$bot/project.json
              if (-not $projectJsonContent) {
                  Write-Warning "project.json not found in commit for $bot."
                  exit 1
              }

              $projectData = $projectJsonContent | ConvertFrom-Json
              $packageName = $projectData.name
              $repoVersion = $projectData.projectVersion.Split(".")
              
              # Use GitHub run number as patch version
              $patch = [int]$repoVersion[2] + 1
              $newVersion = "$($repoVersion[0]).$($repoVersion[1]).$patch"
              Write-Host "ðŸ”¨ Building $bot -> Version: $newVersion -> old version : $($projectData.projectVersion)"

              $projectData.projectVersion = $newVersion

              $existingProjectJsonPath = Join-Path $bot "project.json"

              if (-not (Test-Path $existingProjectJsonPath)) {
                  Write-Error "project.json does not exist in workspace for $bot"
                  exit 1
              }
              
              $projectData | ConvertTo-Json -Depth 10 | Set-Content -Path $existingProjectJsonPath -Force

              Write-Host "âœ… Updated $existingProjectJsonPath"

             # ---- Save to artifacts ----
              $botArtifactPath = Join-Path $artifactsPath $bot
              if (-not (Test-Path $botArtifactPath)) {
                  New-Item -ItemType Directory -Path $botArtifactPath | Out-Null
              }
      
              $outputProjectJson = Join-Path $botArtifactPath "project.json"
              $projectData |ConvertTo-Json -Depth 10 |Set-Content $outputProjectJson
          

              # Pack the package
              uipcli package pack "$outputProjectJson" --traceLevel Information -o "$botArtifactPath" --libraryOrchestratorUrl "$env:UIPATH_URL" --libraryOrchestratorTenant "$env:UIPATH_TENANT" -A "$env:UIPATH_ORG" -I "$env:UIPATH_CLIENT_ID" -S "$env:UIPATH_CLIENT_SECRET" --libraryOrchestratorApplicationScope "OR.Folders"
          }

      # -----------------------------------------------------------
      # Commit and push updated project.json files back to repo
      # -----------------------------------------------------------
      - name: Commit and push updated project.json files
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          Write-Host "commiting changes of - $existingProjectJsonPath"
          git add $existingProjectJsonPath
          if (-not (git diff --cached --quiet)) {
            git commit -m "Bump project version(s) in project.json"
            git push origin HEAD:${{ github.ref }}
            Write-Host "Committed and pushed updated project.json files."
          } else {
            Write-Host "No changes to commit."
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      #-----------------------------------------------------------
      # Deploy packages
      # -----------------------------------------------------------
      - name: Deploy packages
        shell: pwsh
        run: |
          $environment = "${{ github.event.inputs.environment }}"
          Write-Host "ðŸš€ Deploying to Orchestrator folder: $environment and uipath url - $env:UIPATH_URL"

          $nupkgs = Get-ChildItem "artifacts" -Recurse -Filter *.nupkg
          Write-Host "Anjali artifact $nupkgs"
          if (-not $nupkgs) {
              Write-Host "âš  No artifacts found to deploy."
              exit 0
          }

          foreach ($pkg in $nupkgs) {
              Write-Host "ðŸ“¦ Deploying $($pkg.FullName) to folder $environment"

              uipcli package deploy "$($pkg.FullName)" "$env:UIPATH_URL" "$env:UIPATH_TENANT" -A "$env:UIPATH_ORG" -I "$env:UIPATH_CLIENT_ID" -S "$env:UIPATH_CLIENT_SECRET" -o "$environment" --applicationScope "OR.Folders OR.BackgroundTasks OR.TestSets OR.TestSetExecutions OR.TestSetSchedules OR.Settings.Read OR.Robots.Read OR.Machines.Read OR.Execution OR.Assets OR.Users.Read OR.Jobs OR.Monitoring" --traceLevel Information --entryPointsPath "Main.xaml"
          }

